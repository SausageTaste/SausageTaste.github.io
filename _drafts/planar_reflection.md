---
layout: post
title:  "평면 반사(Planar reflection)의 원리"
comments: true
use_math: true
---

지난번 포스트 ‘[게임이 반사를 구현하는 방법](/2020/11/16/2021-07-14-cg_reflections.html)’에서 다양한 반사 구현 기술에 대해 간단히 살펴보았었는데요.
평면 반사 파트의 경우 굉장히 단순하게 설명하고 넘어갔었지요.
거울이 바닥에 수평으로 놓여 있는 경우에 대해서만 설명했었습니다.
그때 이후로 좀 더 공부를 해서 마침내 그 어떤 각도나 위치에서도 완벽하게 작동하는 평면 반사를 만들어 왔습니다!

이번 글은 수학적인 분야에 더 깊게 들어갈 것입니다.
그러니 게임에서 사용되는 선형대수학에 대한 기초 지식이 있어야 내용 이해가 가능합니다.

# 수학

반사상은 기본적으로 뒤집혀 있어야 합니다.
거울에 비친 얼굴은 좌우가 뒤집혀 있고, 수면에 미친 세상은 위아래가 뒤집혀 있지요.
지난 포스트에서 수면(水面) 반사를 구현할 때 이미지의 위아래를 뒤집는 방식으로 이를 구현했었는데요.
이를 수학적으로 표현하면 다음과 같습니다.

$$
\begin{bmatrix}
    1 &  0 & 0 \\
    0 & -1 & 0 \\
    0 &  0 & 1 \\
\end{bmatrix}
\times 
\begin{bmatrix}
    x \\
    y \\
    x \\
\end{bmatrix}
=
\begin{bmatrix}
     x \\
    -y \\
     x \\
\end{bmatrix}
$$

단순하게 $y$축에 마이너스를 곱해서 위아래를 뒤집었었습니다.
$y$축이 상승 하강 방향을 표현하는 축이라고 했을 때, 이 방향을 따라 위아래로 뒤집으면 그 결과는 물 반사와 같은 모습이 되겠지요.

재밌는 점은, 임의의 방향을 바라보는 거울에 사용될 반사상을 만들 때도 위의 행렬을 그대로 사용하게 됩니다.
대신 전 단계에 공간 전체를 회전시켜서 거울이 바닥에 딱 달라붙는 형태가 되도록 만들어 줍니다.

`거울와 장면 전체를 회전하는 그래픽`

위 영상처럼 거울을 바닥에 눌러붙도록 만드는 변환 행렬을 $A$로 두겠습니다.
이때 공간 전체를 거울을 기준으로 면대칭이 되도록 만드는 변환 행렬은 다음과 같이 구할 수 있습니다.

$$
M_{reflection} = A^{-1} \times 
\begin{bmatrix}
    1 &  0 & 0 & 0 \\
    0 & -1 & 0 & 0 \\
    0 &  0 & 1 & 0 \\
    0 &  0 & 0 & 1 \\
\end{bmatrix}
\times A
$$

$A$는 공간의 수평이동도 수행해야 하므로 아핀 공간에서의 변환인 4x4 행렬이 되어야 합니다.
위의 식을 통해 얻은 행렬 $M_{reflection}$을 이용, 버택스 셰이더에서 다음과 같이 변환하면 반사상 이미지를 얻을 수 있습니다.

$$ \bold{v}^{\prime} = M_{projection} \times M_{view} \times M_{reflection} \times M_{model} \times \bold{v} $$

이 반사상 이미지를 거울이 그려지는 부분에 그대로 갖다 붙이면 완벽한 반사상이 완성됩니다.
여기까지는 그렇게 어렵지 않는 부분일 거라 생각합니다.
가장 어려운 부분은 행렬 $A$를 찾는 부분이겠지요?

$A$는 두 부분으로 이루어져 있습니다. 평행이동 행렬 $T$와 회전 행렬 $R$입니다.

$$ A = T \times R $$

$T$는 평면이 원점과 겹치도록 평행이동을 수행하는 행렬입니다.
그리고 $R$은 평면이 수평이 되도록 원점을 중심으로 회전해 주는 행렬입니다.
이 두 행렬을 결합한 $A$ 행렬을 이용해 변환을 수행하면 평면이 원점과 겹치면서 수평으로 놓기게 됩니다.

$T$와 $R$을 구하려면 우선 평면을 수학적으로 표현해야겠지요.
바로 고등학교 기하와 벡터 시간에 배운 **평면의 방정식**을 사용할 때입니다.

$$ ax + by + cz + d = 0 $$

여기서 $a$, $b$, $c$는 셋이 모여 3차원 벡터를 형성하면 그것은 해당 평면의 법선(normal) 벡터가 됩니다.
이것을 $n$으로 표기하겠습니다.
그리고 $n$을 길이가 1인 단위 벡터로 만든 것을 $\hat{n}$으로 포기하겠습니다.

이것을 사용하면 $T$와 $R$을 쉽게 구할 수 있습니다.

$T$를 구하기 위해서는 평면 위의 아무 점 하나를 선택해 줍시다.
평면의 방정식에서 x와 y 자리에 아무 숫자나 넣고 z에 대하여 정리하면 임의의 점 (x, y, z)를 구할 수 있지요. 그렇게 얻은 3차원 벡터를 $\bold{\alpha} = (\alpha_x, \alpha_y, \alpha_z)$로 두겠습니다.
그러면 T는 다음과 같습니다.

$$
T = 
\begin{bmatrix}
    1 & 0 & 0 & -\alpha_x \\
    0 & 1 & 0 & -\alpha_y \\
    0 & 0 & 1 & -\alpha_z \\
    0 & 0 & 0 & 1 \\
\end{bmatrix}
$$

아핀 변환이 익숙하지 않은 분이라면 이게 뭔 괴상환 모양인가 하실지도 모르겠습니다.
그럴 때는 종이를 꺼내서 직접 계산을 해보면 한 방에 이해가 될 겁니다.

$$
T \times \bold{v} = 
\begin{bmatrix}
    1 & 0 & 0 & -\alpha_x \\
    0 & 1 & 0 & -\alpha_y \\
    0 & 0 & 1 & -\alpha_z \\
    0 & 0 & 0 & 1 \\
\end{bmatrix} 
\times
\begin{bmatrix}
    v_x \\
    v_y \\
    v_z \\
    1 \\
\end{bmatrix} 
=
\begin{bmatrix}
    v_x -\alpha_x \\
    v_y -\alpha_y \\
    v_z -\alpha_z \\
    1 \\
\end{bmatrix} 
$$

실질적으로는 $\bold{v} - \bold{\alpha}$를 4x4 행렬로 표현한 것에 불과하죠.
이렇게 하는 이유는 T를 R과 결합하기 위함입니다.

R을 구하는 법은 조금 복잡합니다.