---
layout: post
title:  "RTX란 무엇인가 1편 - 레이트레이싱"
comments: true
use_math: true
---

*이미지를 클릭하시면 이미지 출처 페이지로 이동합니다. 클릭되지 않는 이미지의 저작권은 제게 있습니다.*  
*Click image to go to the page where I found it. Non clickable images are created by me.*

<br>

![my_rtx](https://lh3.googleusercontent.com/pw/ACtC-3fSLaJXmdMNLXHa7VrXBgfh0NtZHTR50zDFDRriT90sqXDKDKAn88U8_08p32woUF9sw5dx2wXXWWdtvzM_wJVR35f9iS9eIctCM8f7UBHeynx53XIWDWr1ybi6oBpYfaWitEl5QNyrCa5lMISZnmFXDQ=w1292-h970-no?authuser=0)
*내 컴퓨터에 장착되어 있는 RTX 그래픽카드. 너무 이뽀….*

자랑 맞습니다만, 얼마전에 RTX 2060을 장착한 컴퓨터를 새로 장만했습니다. ㅎㅎ
그 동안 팀포2도 50 fps로 간신히 돌리는 노트북을 5년 정도 썼습니다만.
갑자기 성능이 엄청 좋은 컴퓨터를 쓰기 시작하니 정신을 못 차리겠더군요.
컴퓨터 바꾼 날 이후로 과하다 싶을 정도로 게임만 하고 있습니다.
바이바이 내 예쁜 시간아!

아무튼 새 학기도 시작했고 이제부턴 게임 좀 줄이고 좀 더 생산적인 일에 집중해 볼까 합니다.
그 첫 타자로 저에게 크나큰 기쁨을 안겨준 이 RTX란 녀석에 대해 자세히 알아 보기로 했습니다.
저는 게임 엔진 개발 경험이 있기 때문에 분명 그것과 연계하면 좋은 공부가 될 것이라 생각합니다.


# Ⅰ. RTX On

RTX On은 게임 커뮤니티에서 꽤나 유명한 문구이지요.
RTX 기술을 적용하기 전과 후의 사진을 연달아 보여주며 RTX의 아름다움을 뽐내는 마케팅 전략입니다.
저도 그 마케팅에 뿅가 RTX를 지르고 말았죠.

여기서 RT는 레이 트레이싱 Ray Tracing의 약자인 것으로 보입니다.
RTX 그래픽카드는 레이 트레이싱을 실시간으로 할 수 있게 만들어 게임에서도 사용될 수 있게 해주는 하드웨어 장치입니다.

배틀필드 5, 셰도우 오브 더 툼레이더, 마인크래프트 등 몇몇 게임에 RTX가 적용되어 우리의 눈을 즐겁게 해주었습니다.
주로 바닥에 고인 물에 반사가 멋지다던가, 유리창의 반사가 멋지다던가, 총기 표면에 주변 사물이 실시간으로 반사된다던가.
주로 반사 분야가 눈에 많이 띄지요?

[![minecraft_rtx_on](https://specials-images.forbesimg.com/imageserve/5e960aa001879f0006d28d10/960x0.jpg?fit=scale)](https://www.forbes.com/sites/tiriasresearch/2020/04/14/nvidias-rtx-ray-tracing-brings-minecraft-to-life/#69dfbf764236)

Nvidia가 홍보하는 RTX의 주요 개선 분야는 다음과 같습니다.

* 좀 더 사실적인 반사
* 요상한 버그(artifect)가 없는 그림자
* 좀 더 정확한 엠비언트 오클루전(ambient occlusion)
* 대박사건! 실시간 글로벌 일루미네이션

넷 다 복잡한 주제이고 쉽게 설명하는 것이 상당히 어렵습니다.
이번 글에서는 맛보기로 사실적인 반사에 대해서만 좀 더 언급하고 넘어가도록 하겠습니다.


## 1. 좀 더 사실적인 반사

레이 트레이싱이 “Make 반사 great again”을 아주 훌륭하게 수행했다는 건 제 눈으로 똑똑히 봤습니다.
그런데 레이 트레이싱을 못 쓰는 게임에서는 그동안 반사를 어떻게 구현했을까요?
여기에 세 가지가 있습니다.
평면 반사, 큐브맵 반사, 화면공간 반사가 있습니다.
추후 별개의 포스트에서 이 세 반사 구현방식의 특징을 설명해 드리도록 하고, 여기선 간략히 설명 드릴게요.

**평면 반사 (Planar reflection)**는 하프라이프2에서 물 반사를 구현하는데 사용되었는데요.
본질적으로 화면을 두 번 렌더링 하는 것이라서 성능을 반토막 내버립니다.
그리고 이름을 보면 알 수 있듯, 평면이 아닌 물체의 반사를 구현하는 데에는 사용할 수 없습니다.

**큐브맵 반사 (Cubemap reflection)**는 현대 대부분의 게임에서 총이나 사람처럼 복잡하면서 비교적 작은 물체 표면의 반사를 구현하는 데 사용됩니다.
반사된 이미지가 실제 위치와 맞지 않는 문제가 있어 플레이어가 위화감을 느낄 수 있습니다.
총기 표면에 구름이 반사되는데 위치 좀 어긋난다고 눈치채는 사람 없겠지만, 매끈한 타일 바닥에 반사된 상은 조금만 어긋나도 몰입감을 해칠 정도가 되지요.

**화면공간 반사 (Screen space reflection)**는 여러분의 모니터에 그려진 정보를 바탕으로 3차원 공간으로 해석하여, 그 공간에서 반사되는 상을 찾는 기술입니다.
굉장히 빠르면서 아름다운 이미지를 만들 수 있지만, 화면 밖으로 나가버린 물체는 반사되지 못 한다는 큰 문제가 있습니다.
디바의 속바지는 화면 안에 포착되지 않았기 때문에 반사상에도 없습니다.

![screen_space_reflection_dva](/assets/images/graphics_01/screen_space_reflection_dva.jpg)

위 세 개의 반사 구현 방식들은 저마다의 한계가 있습니다.
그런데 레이 트레이싱은 눈속임이 아니라 정말 빛의 행동을 흉내내기 때문에 아주 정확한 반사상을 만들 수 있습니다.
물론 고품질의 반사상을 만드는 건 더 오래 걸리지만, 게이머의 눈을 만족시키는 정도라면 엄청 고품질까지는 필요하지 않겠지요.


# 2. 하이브리드!

![battlefield5_mine](https://steamuserimages-a.akamaihd.net/ugc/1624066447705211073/FACAE4F805833990D98E9A80D7E736B48C01F962/)

배틀필드5처럼 RTX를 지원하는 게임들은 사실 온전히 레이 트레이싱만 사용하는 것은 아닙니다.
장면을 원래 게임이 렌더링 하듯 일반적인 방법으로(레스터라이저) 그린 다음, 그 위에 레이 트레이싱 이미지를 첨가하는 방식입니다.
건물, 풀, 총, 하늘, 구름은 일반적으로 그린 다음, 바닥에 물 웅덩이에서만 레이 트레이싱을 하는 식으로요.

![eevee_vs_cycle](/assets/images/graphics_01/eevee_vs_cycle.jpg)

레스터라이저도 엄청나게 발전했습니다.
위 이미지는 블렌더의 Eevee와 Cycle 렌더러로 각각 렌더링한 것입니다.
우측은 온전히 레이 트레이싱만 사용해 렌더링한 결과물인데, 좌측의 레스터라이저의 결과물과 비교했을 때 큰 차이가 안 느껴지죠?

위에서 본 것처럼, 반사처럼 같은 일부에서만 레스터라이저가 눈에 띄게 부실합니다.
그러니 그런 부분을 선별하여 그곳에서만 레이 트레이싱을 사용한다면 최소한의 비용으로 최대 효율을 뽑아낼 수 있게 되는 것입니다.
이렇게 레스터라이저와 레이 트레이싱의 장점만 쏙쏙 뽑아서 렌더링을 하는 것을 **하이브리드 렌더링 파이브라인 Hybrid Rendering Pipeline**이라고 합니다.

[![hybrid_rendering_pipeline](/assets/images/graphics_01/hybrid_rendering_pipeline.png)](https://media.contentapi.ea.com/content/dam/ea/seed/presentations/pica-pica-and-nv-turing-release.pdf)

레스터라이저는 상당히 복잡하고 난해한 개념입니다.
저는 현재 이것에 대해 설명하는 글을 계획하고 있으며, 그 분량은 적어도 포스트 10개는 넘을 것으로 예상됩니다.
오래 걸릴 것 같으니 기대는 하지 말아 주세요. ㅜㅜ
만약 스스로 이것에 대해 공부해 보고 싶으신 분들은 OpenGL에 대해 공부해 보시기 바랍니다.

이 다음은 레이 트레이싱에 대해 설명해 보겠습니다.


# Ⅱ. 레이 트레이싱 Ray Tracing

이런 글까지 찾아 흘러들어온 분들이라면 RTX 그래픽카드가 어떤 기술을 사용하는지 그 이름 정도는 들어 보셨을 거예요.
네, **레이 트레이싱 (Ray Tracing)** 말입니다.
RTX가 무엇인지, 어떤 능력을 가졌는지 이해하기 위해서는 이 레이 트레이싱이라는 기술에 대해 이해할 필요가 있습니다.


## 1. 광선 Ray

레이 트레이싱이란, 카메라에 도달하는 빛이 어떤 이동 경로를 따라 움직였는지 추적하여 카메라에 어떤 색으로 보일지를 계산해 내는 기술을 말합니다. 빛이 태양이나 조명 등의 광원에서 출발하여 물체와 부딪치며 이리 튕기고 저리 튕기다가 카메라로 들어오는 과정 전체를 추적합니다.

[![](https://heretherebepolygons.files.wordpress.com/2015/03/2000px-ray_trace_diagram-svg.png)](https://heretherebepolygons.wordpress.com/2015/03/12/rd-the-3d-graphics-pipeline-part-3/)

빛이 카메라에 도달하지 못 하면 그 빛은 보이지 않으니 굳이 계산할 필요가 없습니다.
그래서 보통은 빛의 이동 경로를 카메라로부터 광원까지 역순으로 찾아갑니다.
여러분 모니터의 한 픽셀마다 하나의 광선을 발사해야 합니다.
위 그림을 보시면 카메라에서 세 개의 광선을 발사한 모습을 볼 수 있는데요.
화면 전체를 체우는 이미지를 만들려면 각 사각형 하나당 하나씩 광선을 발사해야 합니다.
가장 일반적으로 사용되는 Full HD 모니터를 사용한다면 $1920 \times 1080 = 2073600$개나 되는 광선을 발사해야 합니다.

하지만 2073600개는 한 픽셀당 광선을 하나만 사용할 때 얘기죠?
위 그림에서 그림자로 향하는 광선을 봐주세요.
광선이 도달한 바닥의 저 지점이 그림자 안에 있는지 없는지 알아내려면?
그 지점에서 광선 하나를 전구를 향해 발사하여 그 사이에 어떤 물체가 있는가 확인해야 합니다.
즉, 해당 픽셀에 그림자를 그려야 하는지 확인하려면 각 픽셀마다 광선을 하나씩 더 사용해야 하는데요.
이러면 광선의 개수는 총 $1920 \times 1080 \times 2 = 4147200$가 되는군요.

공 표면에 주변이 반사되는 것도 구현하고 싶다면, 공 표면에서 출발하는 광선 하나를 더 발사해야 합니다.
그 광선이 어떤 물체와 만난다면 그 물체가 공 표면에 그려집니다.
이 경우 한 픽셀당 광선의 수는 3개가 되어 $1920 \times 1080 \times 2 = 6220800$개의 광선을 사용하게 됩니다.
근데 공 위에 그려진 물체도 그림자가 생기거나 반사를 하겠죠?
이런 식으로 꼬리에 꼬리를 물고 광선을 계속계속 추적하면 현실과 매우 비슷한 그림을 얻을 수 있습니다.
모니터 해상도 크기에 따라, 원하는 이미지 품질에 따라 광선의 개수가 늘어난다는 사실을 이해할 수 있습니다.


## 2. 장면 복잡도

안 그래도 광선 개수가 너무 많아서 컴퓨터 입장에서는 죽을 맛인데...
그건 빙산의 일각에 불과합니다.
지금부터 ‘광선을 추적한다’는 게 구체적으로 무슨 계산을 의미하는 것인지 함께 알아보도록 해요.

광선을 발사하면 그 광선이 어떤 물체가 충돌을 하겠죠?
이때, 광선과 물체는 컴퓨터에서 어떻게 표현될까요?
컴퓨터는 모든 데이터를 0과 1로만 처리하니, 광선과 물체도 어떻게든 0과 1만으로 표현이 되어야 할 텐데요.
이것을 이해하기 위해 기하와 벡터 책을 펼쳐야 합니다.
네, 이과생 여러분들이 고등학교 수학시간에 공부한 바로 그 과목 말입니다.
(너무 깊에 들어가진 않을 테니 걱정 마세요!)

![image](/assets/images/graphics_01/tri_ray.png)

우선 광선은 2개의 3차원 벡터로 이루어져 있습니다.
광선이 시작하는 지점인 $S$와 끝나는 지점인 $E$로 정하겠습니다.
3차원 벡터는 $(2.3, 6.12, 4.55)$처럼 숫자 세 개로 이루어져 있습니다만.
여기선 중요하지 않으니 참고만 해 주세요.

삼각형은 3개의 벡터로 만들어집니다.
위 그림에서는 각 꼭짓점을 $A$, $B$, $C$라고 이름을 붙였습니다.
광선과 삼각형은 모두 3차원 공간에 있습니다.
점선으로 표시된 부분은 삼각형 뒤에 숨어 안 보이는 영역을 말합니다.

위 그림은 광선이 삼각형과 충돌한 모습이죠.
광선과 삼각형이 만나는 점은 $P$입니다.
점 $P$가 존재하면 광선과 물체가 충돌하기 때문에, 그 지점의 색깔을 알아내서 여러문의 모니터에 그려줍니다.
점 $P$를 시작점 $S$로 삼아 다시 광선을 발사하여 그림자, 반사상을 추가로 알아낼 수도 있죠.

컴퓨터는 우리가 고등학교에서 배운 기하학을 이용하여 저 P점이 존재하는지 아닌지를 알아냅니다.
말로만 간단히 설명 드릴게요.
이해가 안 된다면 그냥 넘어가도 좋아요.

우선은 삼각형의 세 점을 사용해 평면 방정식을 만듭니다.
$Ax + By + Cz + d = 0$ 이렇게 생긴 놈 말이에요.
그리고 그 평면과 광선의 교점을 구합니다.
이 교점이 바로 $P$인데요.
$P$는 평면상에 존재하지만 삼각형 내부에 있을 수도 있고 외부에 있을 수도 있죠.
barycentric 테스트란 신기한 방법을 사용하면 $P$가 삼각형 내부에 있는지 알 수 있습니다.
만약 $P$가 내부에 있다면 충돌을 한 것입니다.
그런데 외부에 있다면 충돌하지 않은 것이므로 무시하고 넘어갑니다.

수학적인 얘기라 복잡하고 재미없죠?
그런데도 굳이 설명하고 넘어간 이유가 있습니다.
후술하겠지만, RTX 그래픽카드가 하는 일이 정확하게 요거예요. ㅎㅎ

암튼!
삼각형 하나와 광선 하나가 출동을 하냐 안 하냐를 판별하는 법은 알았습니다.
왜 삼각형이냐?
여러분도 잘 아시겠지만, 3D 물체들은 폴리곤으로 이루어져 있는데요.
대부분의 경우 삼각형만을 폴리곤으로 사용합니다.
그 어떤 복잡한 물체라도 많은 수의 삼각형을 모아모아 표현할 수 있습니다.

![wireframe_three](/assets/images/graphics_01/wireframe_three.png)

삼각형이 엄청나게 많죠?
사각형이 보인다고요?
쟤네들도 게임에서 사용될 땐 삼각형으로 쪼개서 쓴답니다.
이렇듯 삼각형이 엄청나게 많은데, 광선 하나를 발사하면 위에 보이는 모든 삼각형과 일일이 충돌 검사를 해야 합니다.
위 그림에서 우측에 있는 꽃가마 디바 모델은 삼각형이 1만 5천 개 정도 있습니다. ㄷㄷ
한 픽셀당 광선을 3개씩만 쓴다고 가정해도 $1920 \times 1080 \times 3 \times 15394 = 95762995200$개라는 어마어마한 수의 광선이 필요하군요.
오버워치에서는 이렇게 복잡한 물체의 캐릭터가 최소 12명은 있고, 맵을 그리기 위한 삼각형을 포함하면….

느립니다. 이대로는 실질적으로 사용할 수 없습니다.
다행이도이 토 나올 정도로 많은 삼각형의 개수를 대폭 줄일 수 있는 기술이 존재합니다.


## 3. Bounding Volume Hierarchy

이것도 꽤 복잡한 개념이긴 합니다만.
RTX가 하는 일이 정확이 이거라서 그냥 넘어갈 수도 없는 노릇입니다.

오버워치에서 광선을 하나 발사한 경우를 생각해 봅시다.
우선은 윈스턴 몸의 삼각형 하나하나와 검사해 보니 충돌하지 않았습니다.
그럼 다음은 애쉬 몸의 삼각형, 다음은 맥크리 몸의 삼각형….

그런데 여기서 한 가지 아이디어가 떠오릅니다.
애쉬의 몸 전체를 감싸는 박스를 하나 만듭니다.
그리고 박스와 광선이 충돌하나 확인해 보고, 충돌하지 않으면 애쉬 몸의 삼각형 전체를 무시합니다.
즉, 광선이 애쉬 근처로도 가지 않으면 그 많은 삼각형 근처로도 안 간다는 건 너무나 당연한 사실이죠.
애쉬 뿐만 아니라 모든 캐릭터 각각의 몸을 감싸는 박스를 만들고, 맵도 사각형으로 쪼개서 박스 안에 넣습니다.
그렇게 하면 광선-박스 검사를 통해 엄청나게 많은 수의 삼각형을 무시할 수 있습니다.

[![bvh_youtube](https://i.ytimg.com/vi/rM-BVsdi8c4/maxresdefault.jpg)](https://youtu.be/rM-BVsdi8c4)
*클릭하면 유튜브 영상으로 이동합니다. 꽤 좋은 자료이므로 꼭 보셔요.*

Bounding Volume Hierarchy 이름도 참으로 복잡하군요.
보통 줄여서 BVH라고 부릅니다.
여기서 bounding은 무언가를 감싸고 있다는 의미입니다.
Volume은 부피라는 뜻인데, 여기선 3D 물체와 맵 안에서 공간의 부분을 의미합니다.
Hierarchy는 계층이란 뜻인데요.
박스 세네 개를 감싸는 하나의 박스, 그런 박스들 세네 개를 감싸는 상위 계층의 박스.
이런 식으로 계층을 만들기 때문에 붙은 단어랍니다.
